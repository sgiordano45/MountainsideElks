<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin | Mountainside Elks Lodge #1585</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    .admin-container { max-width: 1000px; margin: 0 auto; padding: var(--space-xl); }
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--gray-50); }
    .login-box { background: var(--white); padding: var(--space-2xl); border-radius: 12px; box-shadow: var(--shadow-lg); width: 100%; max-width: 400px; }
    .login-box h1 { font-size: 1.5rem; margin-bottom: var(--space-xl); text-align: center; }
    .admin-header { background: var(--navy); color: var(--white); padding: var(--space-lg) var(--space-xl); margin-bottom: var(--space-xl); }
    .admin-header__inner { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md); }
    .admin-header h1 { font-size: 1.25rem; color: var(--white); }
    .tabs { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-bottom: var(--space-xl); border-bottom: 2px solid var(--gray-200); padding-bottom: var(--space-sm); }
    .tab { padding: var(--space-sm) var(--space-lg); border: none; background: none; font-size: 0.9rem; font-weight: 600; color: var(--gray-500); cursor: pointer; border-radius: 6px 6px 0 0; transition: all var(--transition-fast); }
    .tab:hover { color: var(--navy); background: var(--gray-50); }
    .tab.active { color: var(--navy); background: var(--gray-100); }
    .tab-badge { background: var(--gold); color: var(--navy-dark); font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; margin-left: var(--space-xs); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .admin-card { background: var(--white); border-radius: 12px; box-shadow: var(--shadow-md); padding: var(--space-xl); margin-bottom: var(--space-xl); }
    .admin-card h2 { font-size: 1.25rem; margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--gray-100); }
    .form-group { margin-bottom: var(--space-lg); }
    .form-group label { display: block; font-weight: 600; margin-bottom: var(--space-sm); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: 6px; font-size: 1rem; font-family: inherit; transition: border-color var(--transition-fast); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--navy); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    .form-hint { font-size: 0.8125rem; color: var(--gray-500); margin-top: var(--space-xs); }
    .event-list { list-style: none; }
    .event-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); border-bottom: 1px solid var(--gray-100); gap: var(--space-md); flex-wrap: wrap; }
    .event-item:last-child { border-bottom: none; }
    .event-item__info { flex: 1; min-width: 200px; }
    .event-item__title { font-weight: 600; margin-bottom: var(--space-xs); }
    .event-item__meta { font-size: 0.875rem; color: var(--gray-500); }
    .event-item__actions { display: flex; gap: var(--space-sm); }
    .event-item--past { opacity: 0.5; }
    .officer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-lg); }
    .officer-card { background: var(--gray-50); border-radius: 8px; padding: var(--space-lg); text-align: center; }
    .officer-card__photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto var(--space-md); background: var(--gray-200); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .officer-card__photo img { width: 100%; height: 100%; object-fit: cover; }
    .officer-card__photo svg { width: 32px; height: 32px; color: var(--gray-400); }
    .officer-card__name { font-weight: 600; margin-bottom: var(--space-xs); font-size: 0.9rem; }
    .officer-card__title { font-size: 0.8rem; color: var(--gray-500); margin-bottom: var(--space-md); }
    .inquiry-item { padding: var(--space-lg); border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: var(--space-md); }
    .inquiry-item--new { border-left: 4px solid var(--gold); background: rgba(212, 160, 18, 0.05); }
    .inquiry-item__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-md); flex-wrap: wrap; gap: var(--space-sm); }
    .inquiry-item__name { font-weight: 600; font-size: 1.125rem; }
    .inquiry-item__date { font-size: 0.875rem; color: var(--gray-500); }
    .inquiry-item__details { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-sm); margin-bottom: var(--space-md); font-size: 0.9rem; }
    .inquiry-item__details strong { color: var(--gray-500); font-weight: 400; }
    .inquiry-item__message { background: var(--gray-50); padding: var(--space-md); border-radius: 6px; margin-bottom: var(--space-md); }
    .inquiry-item__actions { display: flex; flex-wrap: wrap; gap: var(--space-sm); }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-badge--new { background: var(--gold); color: var(--navy-dark); }
    .status-badge--contacted { background: #3182ce; color: white; }
    .status-badge--booked { background: #38a169; color: white; }
    .status-badge--closed, .status-badge--replied { background: var(--gray-400); color: white; }
    .btn--small { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .btn--danger { background: #e53e3e; border-color: #e53e3e; color: white; }
    .btn--danger:hover { background: #c53030; border-color: #c53030; color: white; }
    .btn--ghost { background: transparent; border: 1px solid var(--gray-300); color: var(--gray-600); }
    .btn--ghost:hover { background: var(--gray-50); color: var(--gray-700); }
    .empty-state { text-align: center; padding: var(--space-3xl); color: var(--gray-500); }
    .empty-state__icon { font-size: 3rem; margin-bottom: var(--space-md); }
    .image-upload { border: 2px dashed var(--gray-300); border-radius: 8px; padding: var(--space-xl); text-align: center; cursor: pointer; transition: all var(--transition-fast); }
    .image-upload:hover { border-color: var(--navy); background: var(--gray-50); }
    .image-upload input { display: none; }
    .image-upload__preview { max-width: 200px; max-height: 200px; margin: var(--space-md) auto 0; border-radius: 8px; }
    .alert { padding: var(--space-md) var(--space-lg); border-radius: 6px; margin-bottom: var(--space-lg); }
    .alert--success { background: #c6f6d5; color: #22543d; }
    .alert--error { background: #fed7d7; color: #822727; }
    .hidden { display: none !important; }
    .flyer-preview { max-width: 100px; border-radius: 4px; margin-top: var(--space-sm); }
    .upload-progress { margin-top: var(--space-sm); font-size: 0.875rem; color: var(--gray-500); }
  </style>
</head>
<body>
  
  <!-- Login Screen -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>ü¶å Elks Admin</h1>
      <form id="login-form">
        <div class="form-group">
          <label for="admin-password">Admin Password</label>
          <input type="password" id="admin-password" required placeholder="Enter admin password">
        </div>
        <button type="submit" class="btn btn--primary" style="width: 100%;">Login</button>
        <p id="login-error" style="color: #e53e3e; text-align: center; margin-top: var(--space-md); display: none;"></p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="admin-dashboard" class="hidden">
    <header class="admin-header">
      <div class="admin-header__inner">
        <h1>ü¶å Mountainside Elks Admin</h1>
        <div>
          <a href="index.html" class="btn btn--secondary btn--small" style="margin-right: var(--space-sm);">View Site</a>
          <button id="logout-btn" class="btn btn--ghost btn--small" style="color: var(--white); border-color: var(--white);">Logout</button>
        </div>
      </div>
    </header>

    <div class="admin-container">
      <div class="tabs">
        <button class="tab active" data-tab="events">Events</button>
        <button class="tab" data-tab="recurring">Recurring</button>
        <button class="tab" data-tab="officers">Officers</button>
        <button class="tab" data-tab="inquiries">Inquiries <span class="tab-badge" id="inquiry-count">0</span></button>
        <button class="tab" data-tab="messages">Messages <span class="tab-badge" id="message-count">0</span></button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>

      <!-- Events Tab -->
      <div id="events-tab" class="tab-content active">
        <div class="admin-card">
          <h2>Add Special Event</h2>
          <form id="add-event-form">
            <div class="form-row">
              <div class="form-group">
                <label for="event-title">Event Title *</label>
                <input type="text" id="event-title" required placeholder="e.g., St. Patrick's Day Dinner">
              </div>
              <div class="form-group">
                <label for="event-date">Date *</label>
                <input type="date" id="event-date" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="event-time">Time</label>
                <input type="text" id="event-time" placeholder="e.g., 6:00 PM - 9:00 PM">
              </div>
              <div class="form-group">
                <label for="event-tag">Tag</label>
                <select id="event-tag">
                  <option value="Open to All">Open to All</option>
                  <option value="Members & Guests">Members & Guests</option>
                  <option value="Members Only">Members Only</option>
                  <option value="Fundraiser">Fundraiser</option>
                  <option value="Community Event">Community Event</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="event-emoji">Emoji Icon</label>
                <input type="text" id="event-emoji" placeholder="e.g., üéâ ‚òòÔ∏è ü•©" maxlength="4">
              </div>
              <div class="form-group">
                <label for="event-price">Price/Cost</label>
                <input type="text" id="event-price" placeholder="e.g., $25 per person">
              </div>
            </div>
            <div class="form-group">
              <label for="event-description">Short Description *</label>
              <textarea id="event-description" rows="2" required placeholder="Brief description for event card..."></textarea>
            </div>
            <div class="form-group">
              <label for="event-details">Full Details (optional)</label>
              <textarea id="event-details" rows="4" placeholder="Additional info shown when event is clicked..."></textarea>
            </div>
            <div class="form-group">
              <label for="event-rsvp">RSVP Link (optional)</label>
              <input type="url" id="event-rsvp" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Event Flyer (optional)</label>
              <div class="image-upload" id="event-flyer-upload">
                <input type="file" id="event-flyer" accept="image/*">
                <p>üìÑ Click to upload flyer image</p>
                <p class="form-hint">JPG or PNG, max 5MB</p>
                <img id="event-flyer-preview" class="image-upload__preview hidden">
              </div>
              <p id="event-upload-progress" class="upload-progress hidden"></p>
            </div>
            <button type="submit" class="btn btn--primary">Add Event</button>
          </form>
        </div>
        <div class="admin-card">
          <h2>Upcoming Events</h2>
          <ul id="event-list" class="event-list"><li class="empty-state"><div class="empty-state__icon">üìÖ</div><p>Loading...</p></li></ul>
        </div>
        <div class="admin-card">
          <h2>Past Events</h2>
          <ul id="past-event-list" class="event-list"><li class="empty-state"><div class="empty-state__icon">üìÖ</div><p>Loading...</p></li></ul>
        </div>
      </div>

      <!-- Recurring Events Tab -->
      <div id="recurring-tab" class="tab-content">
        <div class="admin-card">
          <h2>Add Recurring Event</h2>
          <form id="add-recurring-form">
            <div class="form-row">
              <div class="form-group">
                <label for="recurring-title">Event Title *</label>
                <input type="text" id="recurring-title" required placeholder="e.g., Friday Karaoke">
              </div>
              <div class="form-group">
                <label for="recurring-schedule">Schedule *</label>
                <input type="text" id="recurring-schedule" required placeholder="e.g., Every 4th Friday ‚Ä¢ 8:00 PM">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="recurring-emoji">Emoji Icon</label>
                <input type="text" id="recurring-emoji" placeholder="e.g., üé§" maxlength="4">
              </div>
              <div class="form-group">
                <label for="recurring-open">Open to Public?</label>
                <select id="recurring-open">
                  <option value="true">Yes - Open to All</option>
                  <option value="false">No - Members & Guests</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="recurring-description">Description *</label>
              <textarea id="recurring-description" rows="3" required placeholder="Brief description..."></textarea>
            </div>
            <div class="form-group">
              <label for="recurring-sort">Sort Order</label>
              <input type="number" id="recurring-sort" value="10" min="1" max="99">
              <p class="form-hint">Lower numbers appear first</p>
            </div>
            <button type="submit" class="btn btn--primary">Add Recurring Event</button>
          </form>
        </div>
        <div class="admin-card">
          <h2>Current Recurring Events</h2>
          <ul id="recurring-list" class="event-list"><li class="empty-state"><div class="empty-state__icon">üîÑ</div><p>Loading...</p></li></ul>
        </div>
      </div>

      <!-- Officers Tab -->
      <div id="officers-tab" class="tab-content">
        <div class="admin-card">
          <h2>Lodge Officers</h2>
          <p style="color: var(--gray-600); margin-bottom: var(--space-xl);">Upload photos for each officer. Photos will appear on the About page.</p>
          <div id="officers-grid" class="officer-grid"><p>Loading officers...</p></div>
        </div>
        <div class="admin-card">
          <h2 id="officer-form-title">Add New Officer</h2>
          <form id="officer-form">
            <div class="form-row">
              <div class="form-group">
                <label for="officer-name">Name *</label>
                <input type="text" id="officer-name" required placeholder="e.g., John Smith">
              </div>
              <div class="form-group">
                <label for="officer-title">Title *</label>
                <select id="officer-title" required>
                  <option value="">Select title...</option>
                  <option value="Exalted Ruler">Exalted Ruler</option>
                  <option value="Leading Knight">Leading Knight</option>
                  <option value="Loyal Knight">Loyal Knight</option>
                  <option value="Lecturing Knight">Lecturing Knight</option>
                  <option value="Secretary">Secretary</option>
                  <option value="Treasurer">Treasurer</option>
                  <option value="Esquire">Esquire</option>
                  <option value="Inner Guard">Inner Guard</option>
                  <option value="Tiler">Tiler</option>
                  <option value="Chaplain">Chaplain</option>
                  <option value="1 Year Trustee">1 Year Trustee</option>
                  <option value="2 Year Trustee">2 Year Trustee</option>
                  <option value="3 Year Trustee">3 Year Trustee</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="officer-sort">Sort Order</label>
              <input type="number" id="officer-sort" value="10" min="1" max="99">
              <p class="form-hint">1 = Exalted Ruler, 2 = Leading Knight, etc.</p>
            </div>
            <div class="form-group">
              <label>Photo</label>
              <div class="image-upload" id="officer-photo-upload">
                <input type="file" id="officer-photo" accept="image/*">
                <p>üì∑ Click to upload photo</p>
                <p class="form-hint">Square photo works best, max 5MB</p>
                <img id="officer-photo-preview" class="image-upload__preview hidden">
              </div>
              <p id="officer-upload-progress" class="upload-progress hidden"></p>
            </div>
            <input type="hidden" id="officer-id">
            <input type="hidden" id="officer-existing-photo">
            <button type="submit" class="btn btn--primary">Save Officer</button>
            <button type="button" id="officer-cancel" class="btn btn--ghost hidden" style="margin-left: var(--space-sm);">Cancel</button>
          </form>
        </div>
      </div>

      <!-- Inquiries Tab -->
      <div id="inquiries-tab" class="tab-content">
        <div class="admin-card">
          <h2>Hall Rental Inquiries</h2>
          <div id="inquiries-list"><div class="empty-state"><div class="empty-state__icon">üìã</div><p>Loading...</p></div></div>
        </div>
      </div>

      <!-- Messages Tab -->
      <div id="messages-tab" class="tab-content">
        <div class="admin-card">
          <h2>Contact Messages</h2>
          <div id="messages-list"><div class="empty-state"><div class="empty-state__icon">‚úâÔ∏è</div><p>Loading...</p></div></div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings-tab" class="tab-content">
        <div class="admin-card">
          <h2>Change Admin Password</h2>
          <form id="password-form">
            <div class="form-group">
              <label for="current-password">Current Password *</label>
              <input type="password" id="current-password" required>
            </div>
            <div class="form-group">
              <label for="new-password">New Password *</label>
              <input type="password" id="new-password" required minlength="6">
              <p class="form-hint">Minimum 6 characters</p>
            </div>
            <div class="form-group">
              <label for="confirm-password">Confirm New Password *</label>
              <input type="password" id="confirm-password" required>
            </div>
            <div id="password-alert" class="hidden"></div>
            <button type="submit" class="btn btn--primary">Update Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  
  <script>
    // ==========================================
    // GLOBAL STATE
    // ==========================================
    let currentEventFlyer = null;
    let currentOfficerPhoto = null;
    const storage = firebase.storage();

    // ==========================================
    // DOM ELEMENTS
    // ==========================================
    const loginScreen = document.getElementById('login-screen');
    const adminDashboard = document.getElementById('admin-dashboard');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');

    // ==========================================
    // AUTHENTICATION
    // ==========================================
    if (sessionStorage.getItem('elks-admin-auth') === 'true') {
      loginScreen.classList.add('hidden');
      adminDashboard.classList.remove('hidden');
      initAdmin();
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('admin-password').value;
      const submitBtn = loginForm.querySelector('button[type="submit"]');
      submitBtn.textContent = 'Checking...';
      submitBtn.disabled = true;
      loginError.style.display = 'none';
      
      try {
        const doc = await db.collection('siteConfig').doc('admin').get();
        if (!doc.exists) {
          await db.collection('siteConfig').doc('admin').set({ password: 'elks1585', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          if (password === 'elks1585') { loginSuccess(); } else { loginFail(submitBtn); }
        } else {
          if (password === doc.data().password) { loginSuccess(); } else { loginFail(submitBtn); }
        }
      } catch (error) {
        loginError.textContent = 'Error connecting to database.';
        loginError.style.display = 'block';
        submitBtn.textContent = 'Login';
        submitBtn.disabled = false;
      }
    });
    
    function loginSuccess() {
      sessionStorage.setItem('elks-admin-auth', 'true');
      loginScreen.classList.add('hidden');
      adminDashboard.classList.remove('hidden');
      initAdmin();
    }
    
    function loginFail(btn) {
      loginError.textContent = 'Incorrect password.';
      loginError.style.display = 'block';
      btn.textContent = 'Login';
      btn.disabled = false;
    }

    logoutBtn.addEventListener('click', () => { sessionStorage.removeItem('elks-admin-auth'); location.reload(); });

    // ==========================================
    // TAB SWITCHING
    // ==========================================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // ==========================================
    // INITIALIZATION
    // ==========================================
    function initAdmin() {
      loadEvents();
      loadRecurringEvents();
      loadOfficers();
      loadInquiries();
      loadMessages();
      initImageUploads();
    }

    // ==========================================
    // IMAGE UPLOADS (Firebase Storage)
    // ==========================================
    function initImageUploads() {
      // Event flyer upload
      const flyerUpload = document.getElementById('event-flyer-upload');
      const flyerInput = document.getElementById('event-flyer');
      const flyerPreview = document.getElementById('event-flyer-preview');
      flyerUpload.addEventListener('click', () => flyerInput.click());
      flyerInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) { alert('File too large. Max 5MB.'); return; }
          currentEventFlyer = file;
          const reader = new FileReader();
          reader.onload = (e) => { flyerPreview.src = e.target.result; flyerPreview.classList.remove('hidden'); };
          reader.readAsDataURL(file);
        }
      });

      // Officer photo upload
      const photoUpload = document.getElementById('officer-photo-upload');
      const photoInput = document.getElementById('officer-photo');
      const photoPreview = document.getElementById('officer-photo-preview');
      photoUpload.addEventListener('click', () => photoInput.click());
      photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) { alert('File too large. Max 5MB.'); return; }
          currentOfficerPhoto = file;
          const reader = new FileReader();
          reader.onload = (e) => { photoPreview.src = e.target.result; photoPreview.classList.remove('hidden'); };
          reader.readAsDataURL(file);
        }
      });
    }

    async function uploadToStorage(file, folder) {
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
      const path = `${folder}/${timestamp}_${safeName}`;
      const ref = storage.ref(path);
      
      const snapshot = await ref.put(file);
      const url = await snapshot.ref.getDownloadURL();
      return url;
    }

    // ==========================================
    // EVENTS
    // ==========================================
    async function loadEvents() {
      const eventList = document.getElementById('event-list');
      const pastEventList = document.getElementById('past-event-list');
      const today = new Date().toISOString().split('T')[0];
      try {
        const snapshot = await db.collection('events').orderBy('date', 'asc').get();
        const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const upcoming = events.filter(e => e.date >= today);
        const past = events.filter(e => e.date < today).reverse();
        eventList.innerHTML = upcoming.length === 0 ? '<li class="empty-state"><div class="empty-state__icon">üìÖ</div><p>No upcoming events</p></li>' : upcoming.map(e => renderEventItem(e)).join('');
        pastEventList.innerHTML = past.length === 0 ? '<li class="empty-state"><div class="empty-state__icon">üìÖ</div><p>No past events</p></li>' : past.slice(0,10).map(e => renderEventItem(e, true)).join('');
      } catch (error) { console.error(error); eventList.innerHTML = '<li class="empty-state"><p>Error loading events</p></li>'; }
    }

    function renderEventItem(event, isPast = false) {
      const flyerHtml = event.flyerUrl ? `<img src="${event.flyerUrl}" class="flyer-preview" alt="Flyer">` : '';
      return `<li class="event-item ${isPast ? 'event-item--past' : ''}"><div class="event-item__info"><div class="event-item__title">${event.emoji || 'üìÖ'} ${event.title}</div><div class="event-item__meta">${formatDateShort(event.date)}${event.time ? ' ‚Ä¢ ' + event.time : ''} ‚Ä¢ ${event.tag || 'Event'}</div>${flyerHtml}</div><div class="event-item__actions"><button class="btn btn--danger btn--small" onclick="deleteEvent('${event.id}')">Delete</button></div></li>`;
    }

    document.getElementById('add-event-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const progressEl = document.getElementById('event-upload-progress');
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;
      
      try {
        let flyerUrl = null;
        if (currentEventFlyer) {
          progressEl.textContent = 'Uploading flyer...';
          progressEl.classList.remove('hidden');
          flyerUrl = await uploadToStorage(currentEventFlyer, 'event-flyers');
        }
        
        await db.collection('events').add({
          title: document.getElementById('event-title').value,
          date: document.getElementById('event-date').value,
          time: document.getElementById('event-time').value,
          tag: document.getElementById('event-tag').value,
          emoji: document.getElementById('event-emoji').value || 'üìÖ',
          price: document.getElementById('event-price').value,
          description: document.getElementById('event-description').value,
          details: document.getElementById('event-details').value,
          rsvpUrl: document.getElementById('event-rsvp').value,
          flyerUrl: flyerUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        e.target.reset();
        currentEventFlyer = null;
        document.getElementById('event-flyer-preview').classList.add('hidden');
        progressEl.classList.add('hidden');
        loadEvents();
        alert('Event added!');
      } catch (error) { 
        console.error(error);
        alert('Error: ' + error.message); 
      }
      submitBtn.textContent = 'Add Event';
      submitBtn.disabled = false;
    });

    async function deleteEvent(id) {
      if (!confirm('Delete this event?')) return;
      try { await db.collection('events').doc(id).delete(); loadEvents(); } catch (e) { alert('Error deleting'); }
    }

    // ==========================================
    // RECURRING EVENTS
    // ==========================================
    async function loadRecurringEvents() {
      const list = document.getElementById('recurring-list');
      try {
        const snapshot = await db.collection('recurring-events').orderBy('sortOrder', 'asc').get();
        const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        list.innerHTML = events.length === 0 ? '<li class="empty-state"><div class="empty-state__icon">üîÑ</div><p>No recurring events</p></li>' : events.map(e => `<li class="event-item"><div class="event-item__info"><div class="event-item__title">${e.emoji || 'üìÖ'} ${e.title}</div><div class="event-item__meta">${e.schedule} ‚Ä¢ ${e.openToAll ? 'Open to All' : 'Members & Guests'}</div></div><div class="event-item__actions"><button class="btn btn--danger btn--small" onclick="deleteRecurring('${e.id}')">Delete</button></div></li>`).join('');
      } catch (e) { console.error(e); }
    }

    document.getElementById('add-recurring-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await db.collection('recurring-events').add({
          title: document.getElementById('recurring-title').value,
          schedule: document.getElementById('recurring-schedule').value,
          emoji: document.getElementById('recurring-emoji').value || 'üìÖ',
          openToAll: document.getElementById('recurring-open').value === 'true',
          description: document.getElementById('recurring-description').value,
          sortOrder: parseInt(document.getElementById('recurring-sort').value) || 10
        });
        e.target.reset();
        document.getElementById('recurring-sort').value = '10';
        loadRecurringEvents();
        alert('Added!');
      } catch (e) { alert('Error: ' + e.message); }
    });

    async function deleteRecurring(id) {
      if (!confirm('Delete?')) return;
      try { await db.collection('recurring-events').doc(id).delete(); loadRecurringEvents(); } catch (e) { console.error(e); }
    }

    // ==========================================
    // OFFICERS
    // ==========================================
    async function loadOfficers() {
      const grid = document.getElementById('officers-grid');
      try {
        const snapshot = await db.collection('officers').orderBy('sortOrder', 'asc').get();
        const officers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        grid.innerHTML = officers.length === 0 ? '<p style="color: var(--gray-500);">No officers added yet. Use the form below to add officers.</p>' : officers.map(o => `<div class="officer-card"><div class="officer-card__photo">${o.photoUrl ? `<img src="${o.photoUrl}" alt="${o.name}">` : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>`}</div><div class="officer-card__name">${o.name}</div><div class="officer-card__title">${o.title}</div><button class="btn btn--ghost btn--small" onclick="editOfficer('${o.id}')" style="margin-right:4px;">Edit</button><button class="btn btn--danger btn--small" onclick="deleteOfficer('${o.id}')">Delete</button></div>`).join('');
      } catch (e) { console.error(e); grid.innerHTML = '<p>Error loading officers</p>'; }
    }

    document.getElementById('officer-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const progressEl = document.getElementById('officer-upload-progress');
      submitBtn.textContent = 'Saving...';
      submitBtn.disabled = true;
      
      try {
        let photoUrl = document.getElementById('officer-existing-photo').value || null;
        
        if (currentOfficerPhoto) {
          progressEl.textContent = 'Uploading photo...';
          progressEl.classList.remove('hidden');
          photoUrl = await uploadToStorage(currentOfficerPhoto, 'officer-photos');
        }
        
        const officerId = document.getElementById('officer-id').value;
        const data = { 
          name: document.getElementById('officer-name').value, 
          title: document.getElementById('officer-title').value, 
          sortOrder: parseInt(document.getElementById('officer-sort').value) || 10, 
          updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        };
        if (photoUrl) data.photoUrl = photoUrl;
        
        if (officerId) { 
          await db.collection('officers').doc(officerId).update(data); 
        } else { 
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 
          await db.collection('officers').add(data); 
        }
        
        resetOfficerForm();
        loadOfficers();
        alert('Officer saved!');
      } catch (error) { 
        console.error(error);
        alert('Error: ' + error.message); 
      }
      submitBtn.textContent = 'Save Officer';
      submitBtn.disabled = false;
    });

    async function editOfficer(id) {
      try {
        const doc = await db.collection('officers').doc(id).get();
        if (doc.exists) {
          const o = doc.data();
          document.getElementById('officer-form-title').textContent = 'Edit Officer';
          document.getElementById('officer-id').value = id;
          document.getElementById('officer-name').value = o.name;
          document.getElementById('officer-title').value = o.title;
          document.getElementById('officer-sort').value = o.sortOrder || 10;
          document.getElementById('officer-existing-photo').value = o.photoUrl || '';
          if (o.photoUrl) { 
            document.getElementById('officer-photo-preview').src = o.photoUrl; 
            document.getElementById('officer-photo-preview').classList.remove('hidden'); 
          }
          document.getElementById('officer-cancel').classList.remove('hidden');
          document.getElementById('officer-form').scrollIntoView({ behavior: 'smooth' });
        }
      } catch (e) { console.error(e); }
    }

    function resetOfficerForm() {
      document.getElementById('officer-form').reset();
      document.getElementById('officer-form-title').textContent = 'Add New Officer';
      document.getElementById('officer-id').value = '';
      document.getElementById('officer-existing-photo').value = '';
      document.getElementById('officer-sort').value = '10';
      document.getElementById('officer-photo-preview').classList.add('hidden');
      document.getElementById('officer-cancel').classList.add('hidden');
      document.getElementById('officer-upload-progress').classList.add('hidden');
      currentOfficerPhoto = null;
    }

    document.getElementById('officer-cancel').addEventListener('click', resetOfficerForm);

    async function deleteOfficer(id) {
      if (!confirm('Delete this officer?')) return;
      try { await db.collection('officers').doc(id).delete(); loadOfficers(); } catch (e) { console.error(e); }
    }

    // ==========================================
    // HALL INQUIRIES
    // ==========================================
    async function loadInquiries() {
      const list = document.getElementById('inquiries-list');
      const countBadge = document.getElementById('inquiry-count');
      try {
        const snapshot = await db.collection('hall-inquiries').orderBy('createdAt', 'desc').get();
        const inquiries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        countBadge.textContent = inquiries.filter(i => i.status === 'new').length;
        list.innerHTML = inquiries.length === 0 ? '<div class="empty-state"><div class="empty-state__icon">üìã</div><p>No inquiries yet</p></div>' : inquiries.map(i => renderInquiry(i)).join('');
      } catch (e) { console.error(e); }
    }

    function renderInquiry(i) {
      const date = i.createdAt ? i.createdAt.toDate().toLocaleDateString() : 'Unknown';
      return `<div class="inquiry-item ${i.status === 'new' ? 'inquiry-item--new' : ''}"><div class="inquiry-item__header"><div><div class="inquiry-item__name">${i.name}</div><div class="inquiry-item__date">Submitted: ${date}</div></div><span class="status-badge status-badge--${i.status || 'new'}">${i.status || 'new'}</span></div><div class="inquiry-item__details"><div><strong>Email:</strong> <a href="mailto:${i.email}">${i.email}</a></div><div><strong>Phone:</strong> ${i.phone || 'N/A'}</div><div><strong>Event Date:</strong> ${i.eventDate || 'N/A'}</div><div><strong>Type:</strong> ${i.eventType || 'N/A'}</div><div><strong>Guests:</strong> ${i.guestCount || 'N/A'}</div></div>${i.message ? `<div class="inquiry-item__message">${i.message}</div>` : ''}<div class="inquiry-item__actions"><button class="btn btn--small btn--ghost" onclick="updateInquiryStatus('${i.id}', 'contacted')">Contacted</button><button class="btn btn--small btn--ghost" onclick="updateInquiryStatus('${i.id}', 'booked')">Booked</button><button class="btn btn--small btn--ghost" onclick="updateInquiryStatus('${i.id}', 'closed')">Close</button><button class="btn btn--small btn--danger" onclick="deleteInquiry('${i.id}')">Delete</button></div></div>`;
    }

    async function updateInquiryStatus(id, status) { try { await db.collection('hall-inquiries').doc(id).update({ status }); loadInquiries(); } catch (e) { console.error(e); } }
    async function deleteInquiry(id) { if (!confirm('Delete?')) return; try { await db.collection('hall-inquiries').doc(id).delete(); loadInquiries(); } catch (e) { console.error(e); } }

    // ==========================================
    // CONTACT MESSAGES
    // ==========================================
    async function loadMessages() {
      const list = document.getElementById('messages-list');
      const countBadge = document.getElementById('message-count');
      try {
        const snapshot = await db.collection('contact-messages').orderBy('createdAt', 'desc').get();
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        countBadge.textContent = messages.filter(m => m.status === 'new').length;
        list.innerHTML = messages.length === 0 ? '<div class="empty-state"><div class="empty-state__icon">‚úâÔ∏è</div><p>No messages yet</p></div>' : messages.map(m => renderMessage(m)).join('');
      } catch (e) { console.error(e); }
    }

    function renderMessage(m) {
      const date = m.createdAt ? m.createdAt.toDate().toLocaleDateString() : 'Unknown';
      return `<div class="inquiry-item ${m.status === 'new' ? 'inquiry-item--new' : ''}"><div class="inquiry-item__header"><div><div class="inquiry-item__name">${m.name}</div><div class="inquiry-item__date">${date} ‚Ä¢ ${m.subject || 'General'}</div></div><span class="status-badge status-badge--${m.status || 'new'}">${m.status || 'new'}</span></div><div class="inquiry-item__details"><div><strong>Email:</strong> <a href="mailto:${m.email}">${m.email}</a></div><div><strong>Phone:</strong> ${m.phone || 'N/A'}</div></div><div class="inquiry-item__message">${m.message}</div><div class="inquiry-item__actions"><button class="btn btn--small btn--ghost" onclick="updateMessageStatus('${m.id}', 'replied')">Replied</button><button class="btn btn--small btn--danger" onclick="deleteMessage('${m.id}')">Delete</button></div></div>`;
    }

    async function updateMessageStatus(id, status) { try { await db.collection('contact-messages').doc(id).update({ status }); loadMessages(); } catch (e) { console.error(e); } }
    async function deleteMessage(id) { if (!confirm('Delete?')) return; try { await db.collection('contact-messages').doc(id).delete(); loadMessages(); } catch (e) { console.error(e); } }

    // ==========================================
    // PASSWORD CHANGE
    // ==========================================
    document.getElementById('password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const alertEl = document.getElementById('password-alert');
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword !== confirmPassword) { 
        alertEl.className = 'alert alert--error'; 
        alertEl.textContent = 'Passwords do not match.'; 
        alertEl.classList.remove('hidden'); 
        return; 
      }
      if (newPassword.length < 6) { 
        alertEl.className = 'alert alert--error'; 
        alertEl.textContent = 'Password must be at least 6 characters.'; 
        alertEl.classList.remove('hidden'); 
        return; 
      }
      
      try {
        const doc = await db.collection('siteConfig').doc('admin').get();
        if (!doc.exists || doc.data().password !== currentPassword) { 
          alertEl.className = 'alert alert--error'; 
          alertEl.textContent = 'Current password is incorrect.'; 
          alertEl.classList.remove('hidden'); 
          return; 
        }
        await db.collection('siteConfig').doc('admin').update({ 
          password: newPassword, 
          updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        });
        alertEl.className = 'alert alert--success';
        alertEl.textContent = 'Password updated!';
        alertEl.classList.remove('hidden');
        e.target.reset();
      } catch (error) { 
        alertEl.className = 'alert alert--error'; 
        alertEl.textContent = 'Error: ' + error.message; 
        alertEl.classList.remove('hidden'); 
      }
    });
  </script>
</body>
</html>
